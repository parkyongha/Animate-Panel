<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script>
        let localServer;
        const serverPath = `${__dirname}/server/main.js`;

        /**
        * ì‹¤ì œ ì„œë²„ ëª¨ë“ˆì„ require í•´ì„œ run()ì„ í˜¸ì¶œí•˜ê³ 
        * ìƒì„±ëœ httpServer ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        */
        function createServerInstance() {
            // ìºì‹œì—ì„œ ì§€ì›Œì„œ í•­ìƒ ìµœì‹  ì½”ë“œë¥¼ ë¡œë“œ

            const resolved = cep_node.require.resolve(serverPath);
            delete cep_node.require.cache[resolved];

            // ëª¨ë“ˆ ê°€ì ¸ì™€ì„œ ì‹¤í–‰ â†’ httpServer ë°˜í™˜
            return cep_node.require(serverPath)();
        }

        /**
         * ì„œë²„ë¥¼ (ìž¬)ì‹œìž‘í•©ë‹ˆë‹¤.
         * ì´ì „ ì¸ìŠ¤í„´ìŠ¤ê°€ ìžˆìœ¼ë©´ ë‹«ì€ ë’¤, ì§§ì€ ë”œë ˆì´ë¥¼ ë‘ê³  ìƒˆë¡œ ë„ì›ë‹ˆë‹¤.
         */
        function reloadServer() {
            if (localServer) {
                localServer.close(() => {
                    console.log('ðŸ”’ Previous server closed');
                    // í¬íŠ¸ê°€ ì™„ì „ížˆ í•´ì œëœ í›„ì— ìƒˆë¡œ ì‹œìž‘

                    setTimeout(() => {
                        console.log('ðŸš€ Starting new server instance');
                        localServer = createServerInstance();
                    }, 100);
                });
            } else {
                console.log('ðŸš€ Initial server start');
                localServer = createServerInstance();
            }
        }

        // ìµœì´ˆ ì‹¤í–‰
        reloadServer();

    </script>

    <title>local server</title>
    <style>
        #consoleToggle {
            position: fixed;
            bottom: 180px;
            right: 20px;
            padding: 6px 12px;
            background: #333;
            color: #fff;
            border: none;
            cursor: pointer;
            z-index: 1000;
        }

        #consolePanel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 500px;
            height: 150px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            padding: 8px;
            box-sizing: border-box;
            display: none;
            z-index: 999;
        }

        #consolePanel .log-entry {
            margin: 2px 0;
        }

        #consolePanel .log-entry.error {
            color: #f66;
        }

        #consolePanel .log-entry.warn {
            color: #fc0;
        }

        #consolePanel .log-entry.info {
            color: #6cf;
        }
    </style>
</head>

<body>
    <h1>Local Server</h1>
    <button id="consoleToggle">ì½˜ì†” í† ê¸€</button>
    <div id="consolePanel"></div>

    <script>
        // ì½˜ì†” ê¸°ë¡ìš©
        (function () {
            const panel = document.getElementById('consolePanel');
            const toggle = document.getElementById('consoleToggle');

            // í† ê¸€ ë™ìž‘
            toggle.addEventListener('click', () => {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });

            // ì›ë³¸ ì½˜ì†” ë©”ì„œë“œ ì €ìž¥
            const orig = {
                log: console.log,
                info: console.info,
                warn: console.warn,
                error: console.error
            };

            // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
            function appendLog(level, args) {
                const entry = document.createElement('div');
                entry.className = 'log-entry ' + level;
                const time = new Date().toLocaleTimeString();
                entry.textContent = `[${time}] ${args.map(a =>
                    typeof a === 'object' ? JSON.stringify(a) : a
                ).join(' ')}`;
                panel.appendChild(entry);
                panel.scrollTop = panel.scrollHeight;
            }

            // ê° ë ˆë²¨ë³„ë¡œ ê°ì‹¸ê¸°
            ['log', 'info', 'warn', 'error'].forEach(level => {
                console[level] = function (...args) {
                    appendLog(level, args);
                    orig[level].apply(console, args);
                };
            });

            // uncaught error í¬ì°©
            window.addEventListener('error', e => {
                appendLog('error', [e.message + ' (' + e.filename + ':' + e.lineno + ')']);
            });
        })();
    </script>
</body>

</html>